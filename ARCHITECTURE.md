# Архитектура проекта

## Обзор

Телеграм-бот для управления вайтлистом построен на основе polling-модели и использует SQLite для хранения данных.

## Компоненты

### 1. main.go
**Точка входа в приложение**

- Инициализирует конфигурацию из переменных окружения
- Создает подключение к базе данных
- Запускает бота

### 2. config.go
**Управление конфигурацией**

Отвечает за загрузку конфигурации из переменных окружения:
- `BOT_TOKEN` - токен Telegram бота
- `ADMIN_ID` - Telegram ID администратора

### 3. database.go
**Слой доступа к данным**

Управляет всеми операциями с базой данных SQLite:

**Структуры данных:**
- `WhitelistRequest` - модель заявки на вайтлист
- `RequestStatus` - статус заявки (pending/approved/rejected)

**Основные методы:**
- `NewDatabase()` - создание подключения и инициализация схемы
- `CreateRequest()` - создание новой заявки
- `GetPendingRequests()` - получение всех ожидающих заявок
- `GetRequestByID()` - получение заявки по ID
- `UpdateRequestStatus()` - обновление статуса заявки
- `GetUserLastRequest()` - получение последней заявки пользователя

**Схема базы данных:**
```sql
CREATE TABLE whitelist_requests (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    username TEXT,
    nickname TEXT NOT NULL,
    status TEXT NOT NULL DEFAULT 'pending',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 4. bot.go
**Основная логика бота**

Управляет взаимодействием с Telegram API и обработкой пользовательских команд.

**Структура Bot:**
- `api` - клиент Telegram Bot API
- `db` - подключение к базе данных
- `config` - конфигурация приложения
- `userState` - хранение состояний пользователей (для multi-step диалогов)

**Основные обработчики:**

**Общие команды:**
- `/start` - приветствие и список команд

**Команды пользователя:**
- `/apply` - начать процесс подачи заявки
- `/status` - проверить статус заявки
- `/cancel` - отменить текущее действие

**Команды администратора:**
- `/pending` - просмотреть все ожидающие заявки
- Inline-кнопки для одобрения/отклонения заявок

**Обработчики событий:**
- `handleMessage()` - обработка текстовых сообщений и команд
- `handleCallbackQuery()` - обработка нажатий на inline-кнопки
- `handleNicknameInput()` - обработка ввода никнейма пользователем

## Поток данных

### Подача заявки пользователем

```
Пользователь -> /apply
    ↓
Бот устанавливает состояние "waiting_nickname"
    ↓
Пользователь отправляет никнейм
    ↓
Бот создает запись в БД (status: pending)
    ↓
Пользователь получает подтверждение
    ↓
Администратор получает уведомление
```

### Обработка заявки администратором

```
Администратор -> /pending
    ↓
Бот отправляет список заявок с inline-кнопками
    ↓
Администратор нажимает "Одобрить" или "Отклонить"
    ↓
Бот обновляет статус в БД
    ↓
Администратор видит обновленное сообщение
    ↓
Пользователь получает уведомление о решении
```

### Проверка статуса

```
Пользователь -> /status
    ↓
Бот запрашивает последнюю заявку из БД
    ↓
Пользователь видит информацию о заявке
```

## Состояния пользователя

Бот использует in-memory карту для отслеживания состояний пользователей:

- `waiting_nickname` - ожидание ввода никнейма для заявки

Состояния хранятся только во время работы бота и сбрасываются при перезапуске.

## Безопасность

### Проверка прав администратора

Все административные действия проверяют ID пользователя:
```go
if userID == b.config.AdminID {
    // Административные действия
}
```

### Валидация данных

- Никнейм не может быть пустым
- Максимальная длина никнейма: 100 символов
- Проверка на дублирование активных заявок

## Уведомления

### Пользователь получает уведомления:
1. При подтверждении подачи заявки
2. При одобрении заявки администратором
3. При отклонении заявки администратором

### Администратор получает уведомления:
1. При поступлении новой заявки

## Расширяемость

Архитектура поддерживает легкое добавление новых функций:

1. **Новые команды** - добавить обработчик в `handleMessage()`
2. **Новые статусы** - расширить `RequestStatus` enum
3. **Дополнительные поля** - изменить схему БД и структуру `WhitelistRequest`
4. **Множественные админы** - заменить `AdminID int64` на `AdminIDs []int64`

## Зависимости

- `github.com/go-telegram-bot-api/telegram-bot-api/v5` - Telegram Bot API клиент
- `github.com/mattn/go-sqlite3` - SQLite3 драйвер для Go
- Стандартная библиотека Go

## Ограничения

- Состояния пользователей хранятся в памяти (сбрасываются при перезапуске)
- Один администратор (легко расширяется)
- Polling вместо webhooks (можно переключиться при необходимости)

## Производительность

- SQLite подходит для малых и средних нагрузок (до 10-100 заявок в минуту)
- Для больших нагрузок рекомендуется PostgreSQL/MySQL
- Polling с таймаутом 60 секунд обеспечивает быстрый отклик

